name: Docker CI Tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  docker-build-test:
    runs-on: ubuntu-latest
    
    env:
      DOCKER_BUILDKIT: 0
      COMPOSE_DOCKER_CLI_BUILD: 0
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug checkout
      run: |
        echo "Checking git status and files..."
        git status
        echo "=== Files in root ==="
        find . -maxdepth 2 -type f | head -20
        echo "=== Specific files we need ==="
        ls -lah backend/tsconfig.json
        ls -lah backend/dockerfile  
        ls -lah shared/types.ts || echo "shared/types.ts not found"
        file backend/tsconfig.json

    - name: Configure Docker for legacy builder
      run: |
        # Use legacy docker builder
        docker version
        docker info | grep -i buildkit || echo "BuildKit status unknown"

    - name: Create backend .env file
      run: |
        cd backend
        cat > .env << EOF
        PORT=5000
        DB_TYPE=mysql
        DB_HOST=mysqldb
        DB_PORT=3306
        DB_USERNAME=root
        DB_PASSWORD=
        DB_DATABASE=AssociationCoranique
        JWT_SECRET=test-secret-key-for-ci
        JWT_REFRESH_SECRET=test-refresh-secret-key-for-ci
        JWT_EXP_IN=1h
        JWT_REFRESH_EXP_IN=7d
        JWT_RESET_PSWD_EXP_IN=15m
        EOF

    - name: Verify build context
      run: |
        echo "Current directory: $(pwd)"
        ls -la
        if [ ! -d "backend" ]; then
          echo "ERROR: backend directory not found"
          exit 1
        fi
        echo "=== Backend directory contents ==="
        ls -la backend/
        echo "=== Checking tsconfig.json ==="
        if [ -f "backend/tsconfig.json" ]; then
          echo "✓ backend/tsconfig.json exists"
          cat backend/tsconfig.json
        else
          echo "ERROR: backend/tsconfig.json not found"
          exit 1
        fi
        echo "=== Checking shared directory ==="
        if [ -d "shared" ]; then
          echo "✓ shared directory exists"
          ls -la shared/
        else
          echo "ERROR: shared directory not found"
          exit 1
        fi
        echo "✓ Build context verified"

    - name: Build Docker images
      run: |
        # Build backend with absolute minimal flags
        docker build --no-cache -t back-end-backend:latest -f ./backend/dockerfile .
        
        # Build frontend
        docker build --no-cache -t back-end-frontend:latest -f ./frontend/dockerfile ./frontend
        
        # Verify images were created
        docker images | grep back-end
      timeout-minutes: 10

    - name: Start Docker containers (CI mode - no volumes)
      run: docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d
      timeout-minutes: 5

    - name: Wait for MySQL to be ready
      run: |
        echo "Waiting for MySQL to be ready..."
        for i in {1..30}; do
          if docker compose exec -T mysqldb mysqladmin ping -h localhost --silent; then
            echo "✓ MySQL is ready after ${i} attempts"
            break
          fi
          echo "Attempt $i: MySQL not ready, waiting..."
          sleep 2
        done
        
        # Verify database was created
        echo "=== Checking if database exists ==="
        docker compose exec -T mysqldb mysql -e "SHOW DATABASES;" | grep AssociationCoranique || echo "Database AssociationCoranique not found"

    - name: Wait for backend to be ready
      run: |
        echo "Waiting for backend to start..."
        for i in {1..30}; do
          if curl -f http://localhost:5000/ 2>/dev/null; then
            echo "✓ Backend is responding after ${i} attempts"
            break
          fi
          echo "Attempt $i: Backend not ready, waiting..."
          sleep 3
        done
        
    - name: Check backend container status and logs
      if: always()
      run: |
        echo "=== Container Status ==="
        docker compose ps
        echo "=== Backend Container Logs ==="
        docker compose logs backend
        echo "=== MySQL Container Logs ==="
        docker compose logs mysqldb | tail -20

    - name: Test backend is running
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/)
        echo "Root endpoint response: $response"
        if [ "$response" != "200" ]; then
          echo "Backend root endpoint check failed with status $response"
          docker compose logs backend
          exit 1
        fi

    - name: Test Swagger documentation exists
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api-docs/)
        echo "Swagger docs response: $response"
        if [ "$response" != "200" ] && [ "$response" != "301" ] && [ "$response" != "302" ]; then
          echo "Swagger documentation not accessible (status: $response)"
          docker compose logs backend
          exit 1
        fi
        echo "✓ Swagger documentation is accessible"

    - name: Test shared types are accessible
      run: |
        echo "Testing that shared types module is properly resolved..."
        docker compose exec -T backend sh -c "node -e \"require('ts-node/register'); require('tsconfig-paths/register'); console.log('Shared types accessible')\""
        echo "✓ Shared types module is accessible in Docker"

    - name: Test database connection
      run: |
        response=$(curl -s http://localhost:5000/)
        if echo "$response" | grep -q "Welcome.*Express.*TypeScript"; then
          echo "✓ Backend is responding correctly"
        else
          echo "Backend response unexpected, checking logs..."
          docker compose logs backend | grep -i "database\|mysql\|typeorm" | tail -20
        fi

    - name: Test API endpoints
      run: |
        # Test admin login endpoint exists
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/admin/login \
          -H "Content-Type: application/json" \
          -d '{"username":"test","password":"test"}')
        echo "Admin login endpoint response: $response"
        if [ "$response" != "400" ] && [ "$response" != "401" ] && [ "$response" != "404" ]; then
          echo "Admin login endpoint may not be working correctly (status: $response)"
        else
          echo "✓ Admin login endpoint exists (returned expected auth error)"
        fi

        # Test teacher login endpoint exists
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/teacher/login \
          -H "Content-Type: application/json" \
          -d '{"code":"test","password":"test"}')
        echo "Teacher login endpoint response: $response"
        if [ "$response" != "400" ] && [ "$response" != "401" ] && [ "$response" != "404" ]; then
          echo "Teacher login endpoint may not be working correctly (status: $response)"
        else
          echo "✓ Teacher login endpoint exists (returned expected auth error)"
        fi

        # Test user login endpoint exists
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/user/login \
          -H "Content-Type: application/json" \
          -d '{"identifier":"test","birthDate":"01/01/2000"}')
        echo "User login endpoint response: $response"
        if [ "$response" != "400" ] && [ "$response" != "401" ] && [ "$response" != "404" ]; then
          echo "User login endpoint may not be working correctly (status: $response)"
        else
          echo "✓ User login endpoint exists (returned expected auth error)"
        fi

    - name: Test frontend is running
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5173/)
        echo "Frontend response: $response"
        if [ "$response" != "200" ]; then
          echo "Frontend not accessible (status: $response)"
          docker compose logs frontend
          exit 1
        fi
        echo "✓ Frontend is running"

    - name: Verify TypeScript compilation
      run: |
        echo "Checking backend TypeScript compilation..."
        docker compose exec -T backend sh -c "npm run build 2>&1 || true" | tee build.log
        if grep -q "@shared/types.*not found" build.log; then
          echo "ERROR: Shared types module resolution failed in Docker!"
          exit 1
        fi
        echo "✓ TypeScript compilation successful (no module resolution errors)"

    - name: Stop containers
      if: always()
      run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v

  docker-compose-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create backend .env file
      run: |
        cd backend
        cat > .env << EOF
        PORT=5000
        DB_TYPE=mysql
        DB_HOST=mysqldb
        DB_PORT=3306
        DB_USERNAME=root
        DB_PASSWORD=
        DB_DATABASE=AssociationCoranique
        JWT_SECRET=test-secret-key-for-ci
        JWT_REFRESH_SECRET=test-refresh-secret-key-for-ci
        JWT_EXP_IN=1h
        JWT_REFRESH_EXP_IN=7d
        JWT_RESET_PSWD_EXP_IN=15m
        EOF

    - name: Validate docker-compose.yml
      run: |
        docker compose config > /dev/null
        echo "✓ docker-compose.yml is valid"

    - name: Check shared folder mount
      run: |
        if ! grep -q "shared:/app/shared" docker-compose.yml; then
          echo "✗ Missing shared folder mount in docker-compose.yml"
          exit 1
        fi
        echo "✓ Shared folder mount configured"

    - name: Check tsconfig.json mount
      run: |
        if ! grep -q "tsconfig.json:/app/tsconfig.json" docker-compose.yml; then
          echo "✗ Missing tsconfig.json mount in docker-compose.yml"
          exit 1
        fi
        echo "✓ tsconfig.json mount configured"

    - name: Verify build context
      run: |
        if ! grep -q "context: ." docker-compose.yml; then
          echo "✗ Backend build context should be '.' in docker-compose.yml"
          exit 1
        fi
        echo "✓ Build context is correct"

    - name: Check .dockerignore exists
      run: |
        if [ ! -f .dockerignore ]; then
          echo "✗ Root .dockerignore file not found"
          exit 1
        fi
        if ! grep -q "backend/node_modules" .dockerignore; then
          echo "✗ .dockerignore missing backend/node_modules exclusion"
          exit 1
        fi
        echo "✓ .dockerignore properly configured"
